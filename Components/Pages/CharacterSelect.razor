@page "/"
@page "/characters"
@inject PlayerCharacterService CharService
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4" style="overflow:scroll !important">
  @if(DiscordName != null) {
    
    <h2>Characters for @DiscordName:</h2>
  }
  else{
  <div class="d-flex flex-column" style="margin-top:30vh;">
    <h1 class="text-center">Nothing to see here...</h1>
    <h3 class="text-center text-muted">(sign in to see your characters)</h3>
  </div>
  }

  <div class="d-flex flex-wrap" style="overflow:scroll !important">
    @if(Characters != null) {
      
      @foreach (var character in Characters)
      {
          <div class="card" style="min-width: 33%; flex-grow: 1;">

            <a class="d-block text-reset text-decoration-none" href="characters/@character.Id">
              <div class="card-header">
                <span> @character.Name </span>
                <span class="float-right">Level @character.Level </span>
              </div>


                <div class="card-body d-flex">
              <div class="flex-grow-1 d-flex row">
                @if(@character.Stats != null) {
                    <StatBlock Stats="@character.Stats" />
                  }
              </div>

              @if(character.MaxHealth != null) {

                <!-- <div class="float-right d-flex flex-wrap flex-shrink-1"> -->
                  <!-- <Orb Colour="red" Value="@(character.CurrentHealth ?? character.MaxHealth ?? 0)" Max="@(character.MaxHealth ?? 0)"/> -->
                <!-- </div> --> 
              }

                </div>
            </a>
          </div>
      }
    }
  </div>
</div>

@code {
  IEnumerable<PlayerCharacter>? Characters;

  [Parameter]
  public int CharacterId { get; set; }

  public string? DiscordId {get; set;}
  public string? DiscordName {get; set;}

  protected override async Task OnInitializedAsync() {

    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    var user = authState.User;

    // get claim
    DiscordId = user.FindFirst("discord_id")?.Value;
    DiscordName = user.FindFirst("discord_name")?.Value;

    if(DiscordId != null){
      Characters = CharService.GetByDiscordId(DiscordId);
    }
  }
}
